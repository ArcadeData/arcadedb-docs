[[python]]
=== Python

ArcadeDB provides Python support through its PostgreSQL protocol compatibility. This allows Python developers to use familiar PostgreSQL drivers like `psycopg2` or `psycopg3` to interact with ArcadeDB's multi-model database capabilities.

==== Prerequisites

Before using ArcadeDB with Python, ensure you have:

* Python 3.7 or higher installed
* ArcadeDB server running with PostgreSQL plugin enabled
* A PostgreSQL driver for Python installed

==== Installation

Install one of the supported PostgreSQL drivers:

.Using psycopg2 (recommended for most use cases)
[source,bash]
----
pip install psycopg2-binary
----

.Using psycopg3 (for newer Python versions)
[source,bash]
----
pip install psycopg[binary]
----

==== Connection Setup

===== Basic Connection

[source,python]
----
import psycopg2
from psycopg2.extras import RealDictCursor

# Connection parameters
connection_params = {
    'host': 'localhost',
    'port': 5432,
    'database': 'your_database',
    'user': 'root',
    'password': 'your_password'
}

# Establish connection
conn = psycopg2.connect(**connection_params)
cursor = conn.cursor(cursor_factory=RealDictCursor)
----

===== Connection with Error Handling

[source,python]
----
import psycopg2
from psycopg2.extras import RealDictCursor
import logging

def create_connection():
    try:
        conn = psycopg2.connect(
            host='localhost',
            port=5432,
            database='your_database',
            user='root',
            password='your_password'
        )
        return conn
    except psycopg2.Error as e:
        logging.error(f"Error connecting to ArcadeDB: {e}")
        raise

# Usage
conn = create_connection()
cursor = conn.cursor(cursor_factory=RealDictCursor)
----

==== Database Schema Operations

===== Creating Types

[source,python]
----
# Create a document type
cursor.execute("CREATE DOCUMENT TYPE Person")

# Create a vertex type for graph operations
cursor.execute("CREATE VERTEX TYPE User")

# Create an edge type for relationships
cursor.execute("CREATE EDGE TYPE Follows")

# Create type with properties
cursor.execute("""
    CREATE VERTEX TYPE Product (
        name STRING,
        price DECIMAL,
        category STRING,
        created_date DATETIME
    )
""")

conn.commit()
----

===== Creating Indexes

[source,python]
----
# Create index on a property
cursor.execute("CREATE INDEX ON User (email)")

# Create composite index
cursor.execute("CREATE INDEX ON Product (category, price)")

conn.commit()
----

==== CRUD Operations

===== Create (Insert) Operations

[source,python]
----
# Insert a document
cursor.execute("""
    INSERT INTO Person SET name = %s, age = %s, email = %s
""", ("John Doe", 30, "john@example.com"))

# Insert multiple records
people = [
    ("Alice Smith", 25, "alice@example.com"),
    ("Bob Johnson", 35, "bob@example.com"),
    ("Carol Wilson", 28, "carol@example.com")
]

cursor.executemany("""
    INSERT INTO Person SET name = %s, age = %s, email = %s
""", people)

conn.commit()
----

===== Read (Select) Operations

[source,python]
----
# Simple select
cursor.execute("SELECT * FROM Person WHERE age > %s", (25,))
results = cursor.fetchall()

for person in results:
    print(f"Name: {person['name']}, Age: {person['age']}")

# Select with specific fields
cursor.execute("SELECT name, email FROM Person ORDER BY name")
users = cursor.fetchall()

# Count records
cursor.execute("SELECT COUNT(*) as total FROM Person")
count = cursor.fetchone()
print(f"Total persons: {count['total']}")
----

===== Update Operations

[source,python]
----
# Update single record
cursor.execute("""
    UPDATE Person SET age = %s WHERE email = %s
""", (31, "john@example.com"))

# Update multiple records
cursor.execute("""
    UPDATE Person SET category = %s WHERE age > %s
""", ("senior", 30))

conn.commit()
----

===== Delete Operations

[source,python]
----
# Delete specific record
cursor.execute("DELETE FROM Person WHERE email = %s", ("john@example.com",))

# Delete with condition
cursor.execute("DELETE FROM Person WHERE age < %s", (18,))

conn.commit()
----

==== Graph Operations

===== Creating Vertices and Edges

[source,python]
----
# Create vertices
cursor.execute("""
    INSERT INTO User SET name = %s, email = %s
""", ("Alice", "alice@example.com"))

cursor.execute("""
    INSERT INTO User SET name = %s, email = %s  
""", ("Bob", "bob@example.com"))

# Create edge between vertices
cursor.execute("""
    CREATE EDGE Follows 
    FROM (SELECT FROM User WHERE email = %s) 
    TO (SELECT FROM User WHERE email = %s)
    SET created_date = %s
""", ("alice@example.com", "bob@example.com", "2023-01-01"))

conn.commit()
----

===== Graph Traversal Queries

[source,python]
----
# Find all users that Alice follows
cursor.execute("""
    SELECT expand(out('Follows').name) 
    FROM User 
    WHERE email = %s
""", ("alice@example.com",))
following = cursor.fetchall()

# Find followers of Bob
cursor.execute("""
    SELECT expand(in('Follows').name) 
    FROM User 
    WHERE email = %s
""", ("bob@example.com",))
followers = cursor.fetchall()

# Complex traversal with path length
cursor.execute("""
    SELECT name, @rid 
    FROM (
        SELECT expand(out('Follows')[0..2]) 
        FROM User 
        WHERE email = %s
    )
""", ("alice@example.com",))
extended_network = cursor.fetchall()
----

==== Transaction Management

===== Basic Transactions

[source,python]
----
try:
    # Start transaction (automatic with psycopg2)
    cursor.execute("INSERT INTO Person SET name = %s", ("Transaction Test",))
    cursor.execute("UPDATE Person SET verified = true WHERE name = %s", ("Transaction Test",))
    
    # Commit transaction
    conn.commit()
    print("Transaction completed successfully")
    
except psycopg2.Error as e:
    # Rollback on error
    conn.rollback()
    print(f"Transaction failed: {e}")
----

===== Advanced Transaction Handling

[source,python]
----
def transfer_credits(from_user, to_user, amount):
    """Example of atomic transaction for credit transfer"""
    try:
        # Check sender balance
        cursor.execute("""
            SELECT credits FROM User WHERE email = %s
        """, (from_user,))
        sender = cursor.fetchone()
        
        if not sender or sender['credits'] < amount:
            raise ValueError("Insufficient credits")
        
        # Deduct from sender
        cursor.execute("""
            UPDATE User SET credits = credits - %s WHERE email = %s
        """, (amount, from_user))
        
        # Add to receiver
        cursor.execute("""
            UPDATE User SET credits = credits + %s WHERE email = %s
        """, (amount, to_user))
        
        # Log transaction
        cursor.execute("""
            INSERT INTO Transaction SET 
                from_user = %s, 
                to_user = %s, 
                amount = %s,
                timestamp = NOW()
        """, (from_user, to_user, amount))
        
        conn.commit()
        return True
        
    except Exception as e:
        conn.rollback()
        print(f"Transfer failed: {e}")
        return False

# Usage
success = transfer_credits("alice@example.com", "bob@example.com", 100)
----

==== Error Handling

===== Common Exception Handling

[source,python]
----
import psycopg2
from psycopg2 import sql

def safe_query(query, params=None):
    """Execute query with comprehensive error handling"""
    try:
        cursor.execute(query, params)
        return cursor.fetchall()
        
    except psycopg2.IntegrityError as e:
        print(f"Data integrity error: {e}")
        conn.rollback()
        
    except psycopg2.DataError as e:
        print(f"Data error: {e}")
        conn.rollback()
        
    except psycopg2.OperationalError as e:
        print(f"Operational error: {e}")
        # Might need to reconnect
        
    except psycopg2.ProgrammingError as e:
        print(f"Programming error: {e}")
        conn.rollback()
        
    except psycopg2.Error as e:
        print(f"Database error: {e}")
        conn.rollback()
        
    return None

# Usage
results = safe_query("SELECT * FROM Person WHERE age > %s", (25,))
----

===== Connection Pool for Production

[source,python]
----
from psycopg2 import pool
import threading

class DatabasePool:
    def __init__(self, minconn=1, maxconn=10):
        self.pool = psycopg2.pool.ThreadedConnectionPool(
            minconn, maxconn,
            host='localhost',
            port=5432,
            database='your_database',
            user='root',
            password='your_password'
        )
        self.lock = threading.Lock()
    
    def get_connection(self):
        return self.pool.getconn()
    
    def put_connection(self, conn):
        self.pool.putconn(conn)
    
    def close_all(self):
        self.pool.closeall()

# Usage
db_pool = DatabasePool()

def execute_query(query, params=None):
    conn = None
    try:
        conn = db_pool.get_connection()
        cursor = conn.cursor(cursor_factory=RealDictCursor)
        cursor.execute(query, params)
        results = cursor.fetchall()
        conn.commit()
        return results
    except Exception as e:
        if conn:
            conn.rollback()
        raise e
    finally:
        if conn:
            db_pool.put_connection(conn)

# Example usage
users = execute_query("SELECT * FROM User WHERE active = %s", (True,))
----

==== Best Practices

===== 1. Use Parameterized Queries

Always use parameterized queries to prevent SQL injection:

[source,python]
----
# Good - parameterized query
cursor.execute("SELECT * FROM Person WHERE name = %s", (user_input,))

# Bad - string concatenation (vulnerable to SQL injection)
cursor.execute(f"SELECT * FROM Person WHERE name = '{user_input}'")
----

===== 2. Proper Resource Management

Use context managers for automatic resource cleanup:

[source,python]
----
from contextlib import contextmanager

@contextmanager
def get_db_cursor():
    conn = None
    try:
        conn = psycopg2.connect(**connection_params)
        cursor = conn.cursor(cursor_factory=RealDictCursor)
        yield cursor
        conn.commit()
    except Exception as e:
        if conn:
            conn.rollback()
        raise e
    finally:
        if conn:
            conn.close()

# Usage
with get_db_cursor() as cursor:
    cursor.execute("SELECT * FROM Person")
    results = cursor.fetchall()
----

===== 3. Batch Operations

For better performance with multiple operations:

[source,python]
----
# Batch insert using executemany
data = [
    ("Alice", 25, "alice@example.com"),
    ("Bob", 30, "bob@example.com"),
    ("Carol", 28, "carol@example.com")
]

cursor.executemany("""
    INSERT INTO Person SET name = %s, age = %s, email = %s
""", data)

# Or use execute_values for better performance
from psycopg2.extras import execute_values

execute_values(cursor, """
    INSERT INTO Person (name, age, email) VALUES %s
""", data, template=None, page_size=100)
----

===== 4. Configuration Management

[source,python]
----
import os
from dataclasses import dataclass

@dataclass
class DatabaseConfig:
    host: str = os.getenv('ARCADEDB_HOST', 'localhost')
    port: int = int(os.getenv('ARCADEDB_PORT', '5432'))
    database: str = os.getenv('ARCADEDB_DATABASE', 'your_database')
    user: str = os.getenv('ARCADEDB_USER', 'root')
    password: str = os.getenv('ARCADEDB_PASSWORD', '')
    
    def to_dict(self):
        return {
            'host': self.host,
            'port': self.port,
            'database': self.database,
            'user': self.user,
            'password': self.password
        }

# Usage
config = DatabaseConfig()
conn = psycopg2.connect(**config.to_dict())
----

==== Complete Example Application

Here's a complete example that demonstrates many of the concepts covered:

[source,python]
----
import psycopg2
from psycopg2.extras import RealDictCursor
import logging
from contextlib import contextmanager
from datetime import datetime

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class ArcadeDBClient:
    def __init__(self, host='localhost', port=5432, database='social', 
                 user='root', password='password'):
        self.connection_params = {
            'host': host,
            'port': port,
            'database': database,
            'user': user,
            'password': password
        }
    
    @contextmanager
    def get_cursor(self):
        conn = None
        try:
            conn = psycopg2.connect(**self.connection_params)
            cursor = conn.cursor(cursor_factory=RealDictCursor)
            yield cursor
            conn.commit()
        except psycopg2.Error as e:
            logger.error(f"Database error: {e}")
            if conn:
                conn.rollback()
            raise
        finally:
            if conn:
                conn.close()
    
    def setup_schema(self):
        """Initialize database schema"""
        with self.get_cursor() as cursor:
            # Create types
            cursor.execute("CREATE VERTEX TYPE IF NOT EXISTS User")
            cursor.execute("CREATE EDGE TYPE IF NOT EXISTS Follows")
            cursor.execute("CREATE DOCUMENT TYPE IF NOT EXISTS Post")
            
            # Create indexes
            cursor.execute("CREATE INDEX IF NOT EXISTS ON User (email)")
            cursor.execute("CREATE INDEX IF NOT EXISTS ON Post (created_date)")
            
            logger.info("Schema setup completed")
    
    def create_user(self, name, email, age=None):
        """Create a new user"""
        with self.get_cursor() as cursor:
            cursor.execute("""
                INSERT INTO User SET name = %s, email = %s, age = %s, 
                created_date = %s
                RETURN @rid
            """, (name, email, age, datetime.now()))
            
            result = cursor.fetchone()
            logger.info(f"Created user: {name}")
            return result['rid'] if result else None
    
    def create_post(self, user_email, content):
        """Create a new post"""
        with self.get_cursor() as cursor:
            cursor.execute("""
                INSERT INTO Post SET content = %s, created_date = %s,
                author = (SELECT @rid FROM User WHERE email = %s LIMIT 1)
            """, (content, datetime.now(), user_email))
            
            logger.info(f"Created post for user: {user_email}")
    
    def follow_user(self, follower_email, following_email):
        """Create a follow relationship"""
        with self.get_cursor() as cursor:
            cursor.execute("""
                CREATE EDGE Follows 
                FROM (SELECT FROM User WHERE email = %s) 
                TO (SELECT FROM User WHERE email = %s)
                SET created_date = %s
            """, (follower_email, following_email, datetime.now()))
            
            logger.info(f"{follower_email} is now following {following_email}")
    
    def get_user_feed(self, user_email, limit=10):
        """Get posts from users that the given user follows"""
        with self.get_cursor() as cursor:
            cursor.execute("""
                SELECT content, created_date, 
                       expand(author.name) as author_name
                FROM Post 
                WHERE author IN (
                    SELECT expand(out('Follows')) 
                    FROM User 
                    WHERE email = %s
                )
                ORDER BY created_date DESC
                LIMIT %s
            """, (user_email, limit))
            
            return cursor.fetchall()
    
    def get_followers(self, user_email):
        """Get all followers of a user"""
        with self.get_cursor() as cursor:
            cursor.execute("""
                SELECT name, email 
                FROM (
                    SELECT expand(in('Follows')) 
                    FROM User 
                    WHERE email = %s
                )
            """, (user_email,))
            
            return cursor.fetchall()

# Example usage
if __name__ == "__main__":
    # Initialize client
    client = ArcadeDBClient()
    
    try:
        # Setup database schema
        client.setup_schema()
        
        # Create users
        client.create_user("Alice Johnson", "alice@example.com", 28)
        client.create_user("Bob Smith", "bob@example.com", 32)
        client.create_user("Carol Wilson", "carol@example.com", 25)
        
        # Create follow relationships
        client.follow_user("alice@example.com", "bob@example.com")
        client.follow_user("alice@example.com", "carol@example.com")
        client.follow_user("bob@example.com", "carol@example.com")
        
        # Create posts
        client.create_post("bob@example.com", "Hello from Bob!")
        client.create_post("carol@example.com", "Having a great day!")
        client.create_post("bob@example.com", "Python + ArcadeDB = ❤️")
        
        # Get Alice's feed (posts from users she follows)
        feed = client.get_user_feed("alice@example.com")
        print("\nAlice's Feed:")
        for post in feed:
            print(f"- {post['author_name']}: {post['content']}")
        
        # Get Carol's followers
        followers = client.get_followers("carol@example.com")
        print(f"\nCarol's Followers:")
        for follower in followers:
            print(f"- {follower['name']} ({follower['email']})")
            
    except Exception as e:
        logger.error(f"Application error: {e}")
----

// Use of `stubgenj` https://pypi.org/project/stubgenj/